<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StratoPipe - Login</title>
  <link rel="stylesheet" href="/styles/Auth.css">
  <link rel="stylesheet" href="/styles/components.css">
  <script src="/scripts/config.js"></script>
</head>
<body>
  <div class="auth-container">
    <h1>StratoPipe</h1>
    <h2>Login</h2>
    <form id="loginForm">
      <label>
        Username:
          <input type="text" class="neu-input" id="username" name="username" required/>
      </label>
      <label>
        Password:
          <input type="password" class="neu-input" id="password" name="password" required/>
      </label>

      <div class="buttons" style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
        <button class="neu-button" type="submit">
          <span>Login</span>
        </button>

        <!-- Forgot password trigger (uses username to find the email on file) -->
        <button class="neu-button" type="button" id="forgotPasswordBtn" style="background:var(--btn-secondary, #eaeaea); color:inherit;">
          <span>Forgot password?</span>
        </button>
      </div>
    </form>

    <p id="message"></p>
  </div>

<script>
// Small helper around the config to safely build URLs
const API_BASE = (window.APP_CONFIG && window.APP_CONFIG.API_BASE_URL) || 'http://localhost:8000/api/';
const PASSWORD_RESET_DONE_URL = (window.APP_CONFIG && window.APP_CONFIG.PASSWORD_RESET_DONE_URL) || 'http://localhost:8000/reset-password/done/';
function apiUrl(path) {
  return new URL(String(path || '').replace(/^\//, ''), API_BASE).toString();
}

function getCookie(name) {
  const target = name + '=';
  const parts = document.cookie.split(';');
  for (let part of parts) {
    part = part.trim();
    if (part.startsWith(target)) {
      return decodeURIComponent(part.slice(target.length));
    }
  }
  return null;
}

async function ensureCsrfCookie() {
  if (getCookie('csrftoken')) return;
  try { await fetch(apiUrl('csrf/'), { credentials: 'include' }); } catch {}
  if (getCookie('csrftoken')) return;
  try { await fetch(apiUrl(''), { credentials: 'include' }); } catch {}
}

const form = document.getElementById('loginForm');
form.addEventListener('submit', async (event) => {
  event.preventDefault();

  try {
    await ensureCsrfCookie();
    const csrf = getCookie('csrftoken');

    const payload = {
      username: document.getElementById('username').value,
      password: document.getElementById('password').value
    };

    const res = await fetch(apiUrl('auth/login/'), {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...(csrf ? { 'X-CSRFToken': csrf } : {})
      },
      credentials: 'include',
      body: JSON.stringify(payload)
    });

    let data = null;
    try { data = await res.clone().json(); } catch {}

    if (res.ok) {
      if (data?.token || data?.key) {
        const val = data.token || data.key;
        localStorage.setItem('authToken', `Token ${val}`);
      } else if (data?.access || data?.jwt) {
        const val = data.access || data.jwt;
        localStorage.setItem('authToken', val);
      }
      window.location.replace('project-management.html');
    } else {
      const text = data?.error || data?.detail || (await res.text().catch(() => 'Login failed.'));
      document.getElementById('message').textContent = text || `Login failed (${res.status}).`;
    }
  } catch (e) {
    document.getElementById('message').textContent = 'An error occurred during login.';
  }
});

// Forgot password: uses the username to send reset link to the email on file
const forgotBtn = document.getElementById('forgotPasswordBtn');
forgotBtn?.addEventListener('click', async () => {
  const usernameInput = document.getElementById('username');
  const message = document.getElementById('message');
  const username = (usernameInput?.value || '').trim();

  if (!username) {
    message.textContent = 'Please enter your username first to request a password reset.';
    usernameInput?.focus();
    return;
  }

  try {
    await ensureCsrfCookie();
    const csrf = getCookie('csrftoken');

    const PASSWORD_RESET_BY_USERNAME_URL = apiUrl('auth/password-reset-by-username/');

    const res = await fetch(PASSWORD_RESET_BY_USERNAME_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
        ...(csrf ? { 'X-CSRFToken': csrf } : {})
      },
      credentials: 'include',
      body: new URLSearchParams({ username })
    });

    if (res.ok) {
      // Redirect to Django-rendered confirmation page
      window.location.replace(PASSWORD_RESET_DONE_URL);
    } else {
      const text = await res.text().catch(() => '');
      message.textContent = text || 'Unable to process password reset. Please try again.';
    }
  } catch {
    document.getElementById('message').textContent = 'An error occurred while requesting password reset.';
  }
});
</script>
</body>
</html>
