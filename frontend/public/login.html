<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StratoPipe - Login</title>
  <link rel="stylesheet" href="/styles/Auth.css">
  <link rel="stylesheet" href="/styles/components.css">
</head>
<body>
  <div class="auth-container">
    <h1>StratoPipe</h1>
    <h2>Login</h2>
    <form id="loginForm">
      <label>
        Username:
          <input type="text" class="neu-input" id="username" name="username" required/>
      </label>
      <label>
        Password:
          <input type="password" class="neu-input" id="password" name="password" required/>
      </label>

      <div class="buttons">
        <button class="neu-button" type="submit">
          <span>Login</span>
        </button>
      </div>
    </form>
    <p id="message"></p>
  </div>

<!-- HTML -->
<script>
  function getCookie(name) {
    const target = name + '=';
    const parts = document.cookie.split(';');
    for (let part of parts) {
      part = part.trim();
      if (part.startsWith(target)) {
        return decodeURIComponent(part.slice(target.length));
      }
    }
    return null;
  }

  async function ensureCsrfCookie() {
    if (getCookie('csrftoken')) return;
    try { await fetch('/api/csrf/', { credentials: 'include' }); } catch {}
    if (getCookie('csrftoken')) return;
    try { await fetch('/api/', { credentials: 'include' }); } catch {}
  }

  const form = document.getElementById('loginForm');
  form.addEventListener('submit', async (event) => {
    event.preventDefault();

    try {
      await ensureCsrfCookie();
      const csrf = getCookie('csrftoken');

      const payload = {
        username: document.getElementById('username').value,
        password: document.getElementById('password').value
      };

      const res = await fetch('/api/auth/login/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(csrf ? { 'X-CSRFToken': csrf } : {})
        },
        credentials: 'include',
        body: JSON.stringify(payload)
      });

      let data = null;
      try { data = await res.clone().json(); } catch {}

      if (res.ok) {
        if (data?.token || data?.key) {
          const val = data.token || data.key;
          localStorage.setItem('authToken', `Token ${val}`);
        } else if (data?.access || data?.jwt) {
          const val = data.access || data.jwt;
          localStorage.setItem('authToken', val);
        }
        window.location.replace('project-management.html');
      } else {
        const text = data?.error || data?.detail || (await res.text().catch(() => 'Login failed.'));
        document.getElementById('message').textContent = text || `Login failed (${res.status}).`;
      }
    } catch (e) {
      document.getElementById('message').textContent = 'An error occurred during login.';
    }
  });
</script>
