<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>StratoPipe - User Registration</title>
    <link rel="stylesheet" href="/styles/Auth.css">
    <link rel="stylesheet" href="/styles/components.css">
</head>
<body>
    <div class="auth-container">
        <h1>StratoPipe</h1>
        <h2>Register</h2>
        <form id="registerForm">
            <label>
                Username:
                <input type="text" class="neu-input"  id="username" name="username" required>
            </label>
            <label>
                Email:
                <input type="email" class="neu-input" id="email" name="email" required>
            </label>
            <label>
                Password:
                <input type="password" class="neu-input" id="password" name="password" required>
            </label>
            <label>
                Confirm Password:
                <input type="password" class="neu-input" id="confirmPassword" name="confirm_password" required>
            </label>
            <button class="neu-button" type="submit">Register</button>
        </form>
        <p id="message"></p>
    </div>
    <script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('registerForm');
    if (!form) {
      console.warn('Registration form not found');
      return;
    }

    const REGISTER_URL = '/api/auth/register/';
    const LOGIN_URL = '/api/auth/login/';
    const TARGET_URL = '/project-management.html';

    function getCookie(name) {
      const target = name + '=';
      const parts = document.cookie.split(';');
      for (let part of parts) {
        part = part.trim();
        if (part.startsWith(target)) return decodeURIComponent(part.slice(target.length));
      }
      return null;
    }

    async function ensureCsrfCookie() {
      if (getCookie('csrftoken')) return;
      try { await fetch('/api/csrf/', { credentials: 'include' }); } catch {}
      if (getCookie('csrftoken')) return;
      try { await fetch('/api/', { credentials: 'include' }); } catch {}
    }

    async function loginAndStoreToken(username, password, csrf) {
      const res = await fetch(LOGIN_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(csrf ? { 'X-CSRFToken': csrf } : {})
        },
        credentials: 'include',
        body: JSON.stringify({ username, password })
      });

      let data = null;
      try { data = await res.clone().json(); } catch {}

      if (!res.ok) {
        const msg = data?.error || data?.detail || (await res.text().catch(() => 'Login failed.'));
        throw new Error(msg || `Login failed (${res.status}).`);
      }

      try {
        if (data?.token || data?.key) {
          const val = data.token || data.key;
          localStorage.setItem('authToken', `Token ${val}`);
        } else if (data?.access || data?.jwt) {
          const val = data.access || data.jwt;
          localStorage.setItem('authToken', val);
        }
      } catch {}
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const email = document.getElementById('email')?.value || '';
      const messageEl = document.getElementById('message');

      // Client-side password confirmation check
      if (password !== confirmPassword) {
        messageEl.textContent = 'Passwords do not match. Please enter the same password in both fields.';
        return;
      }

      try {
        await ensureCsrfCookie();
        const csrf = getCookie('csrftoken');

        const regRes = await fetch(REGISTER_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(csrf ? { 'X-CSRFToken': csrf } : {})
          },
          credentials: 'include',
          body: JSON.stringify({ username, password, email })
        });

        let regData = null;
        try { regData = await regRes.clone().json(); } catch {}

        if (!regRes.ok) {
          const msg = regData?.error || regData?.detail || (await regRes.text().catch(() => 'Registration failed.'));
          (messageEl || { textContent: null }).textContent =
            msg || `Registration failed (${regRes.status}).`;
          return;
        }

        try {
          if (!(regData?.token || regData?.key || regData?.access || regData?.jwt)) {
            await loginAndStoreToken(username, password, csrf);
          } else {
            if (regData?.token || regData?.key) {
              const val = regData.token || regData.key;
              localStorage.setItem('authToken', `Token ${val}`);
            } else if (regData?.access || regData?.jwt) {
              const val = regData.access || regData.jwt;
              localStorage.setItem('authToken', val);
            }
          }
        } catch (loginErr) {
          (messageEl || { textContent: null }).textContent =
            loginErr.message || 'Login after registration failed.';
          return;
        }

        window.location.assign(TARGET_URL);
      } catch (err) {
        (messageEl || { textContent: null }).textContent =
          'An error occurred during registration.';
      }
    });
  });
</script>
</body>
</html>
